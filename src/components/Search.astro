---
---

<div class="search-container">
  <button class="search-toggle" aria-label="Search" title="Search (Ctrl+K)">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="11" cy="11" r="8" />
      <line x1="21" y1="21" x2="16.65" y2="16.65" />
    </svg>
  </button>

  <dialog class="search-dialog">
    <div id="pagefind-search"></div>
    <button class="search-close" aria-label="Close search">
      <kbd>Esc</kbd>
    </button>
  </dialog>
</div>

<style>
  .search-toggle {
    background: none;
    border: none;
    cursor: pointer;
    color: var(--text-2);
    padding: 0.25rem;
    display: flex;
    align-items: center;
    transition: color 0.2s;
  }

  .search-toggle:hover {
    color: var(--highlight-color);
  }

  .search-dialog {
    border: 1px solid var(--divider);
    border-radius: 0.5rem;
    background: var(--background-color);
    color: var(--text-color);
    max-width: 36rem;
    width: 90vw;
    padding: 1.5rem;
    margin: 10vh auto;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
  }

  .search-dialog::backdrop {
    background: rgba(0, 0, 0, 0.5);
  }

  .search-close {
    position: absolute;
    top: 0.75rem;
    right: 0.75rem;
    background: none;
    border: 1px solid var(--divider);
    border-radius: 0.25rem;
    cursor: pointer;
    color: var(--text-2);
    padding: 0.125rem 0.375rem;
    font-size: 0.75rem;
  }

  .search-close:hover {
    color: var(--text-color);
  }
</style>

<style is:global>
  .pagefind-ui__search-input {
    font-family: var(--font-family-body) !important;
    background: var(--bg-soft) !important;
    color: var(--text-color) !important;
    border: 1px solid var(--divider) !important;
    border-radius: 0.375rem !important;
  }

  .pagefind-ui__result-link {
    color: var(--highlight-color) !important;
  }

  .pagefind-ui__result-excerpt {
    color: var(--text-2) !important;
  }

  .pagefind-ui__button {
    background: var(--highlight-color) !important;
    color: white !important;
  }
</style>

<script is:inline>
  (function() {
    let pagefindLoaded = false

    async function loadPagefind() {
      if (pagefindLoaded) return
      pagefindLoaded = true
      try {
        const link = document.createElement("link")
        link.rel = "stylesheet"
        link.href = "/pagefind/pagefind-ui.css"
        document.head.appendChild(link)

        const script = document.createElement("script")
        script.src = "/pagefind/pagefind-ui.js"
        await new Promise((resolve, reject) => {
          script.onload = resolve
          script.onerror = reject
          document.head.appendChild(script)
        })

        new window.PagefindUI({
          element: "#pagefind-search",
          showSubResults: true,
          showImages: false,
        })
      } catch {
        const el = document.getElementById("pagefind-search")
        if (el) el.innerHTML = "<p>Search is not available in dev mode.</p>"
      }
    }

    function initSearch() {
      const toggle = document.querySelector(".search-toggle")
      const dialog = document.querySelector(".search-dialog")
      const close = document.querySelector(".search-close")

      if (toggle) {
        toggle.addEventListener("click", async function() {
          if (!dialog) return
          await loadPagefind()
          dialog.showModal()
          var input = dialog.querySelector(".pagefind-ui__search-input")
          if (input) input.focus()
        })
      }

      if (close) {
        close.addEventListener("click", function() {
          if (dialog) dialog.close()
        })
      }
    }

    function handleKeydown(e) {
      if ((e.ctrlKey || e.metaKey) && e.key === "k") {
        e.preventDefault()
        var dialog = document.querySelector(".search-dialog")
        if (!dialog) return
        loadPagefind().then(function() {
          if (dialog.open) {
            dialog.close()
          } else {
            dialog.showModal()
            var input = dialog.querySelector(".pagefind-ui__search-input")
            if (input) input.focus()
          }
        })
      }
    }

    document.removeEventListener("keydown", handleKeydown)
    document.addEventListener("keydown", handleKeydown)

    initSearch()
    document.addEventListener("astro:page-load", initSearch)
  })()
</script>
